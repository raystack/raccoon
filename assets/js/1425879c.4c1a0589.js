"use strict";(self.webpackChunkraccoon=self.webpackChunkraccoon||[]).push([[228],{5680:(e,t,n)=>{n.d(t,{xA:()=>c,yg:()=>y});var a=n(6540);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),p=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},g="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),g=p(n),d=r,y=g["".concat(l,".").concat(d)]||g[d]||u[d]||o;return n?a.createElement(y,i(i({ref:t},c),{},{components:n})):a.createElement(y,i({ref:t},c))}));function y(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[g]="string"==typeof e?e:r,i[1]=s;for(var p=2;p<o;p++)i[p]=n[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},4369:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>u,frontMatter:()=>o,metadata:()=>s,toc:()=>p});var a=n(8168),r=(n(6540),n(5680));const o={},i="Publishing Events",s={unversionedId:"guides/publishing",id:"guides/publishing",title:"Publishing Events",description:"EndPoints",source:"@site/docs/guides/publishing.md",sourceDirName:"guides",slug:"/guides/publishing",permalink:"/raccoon/guides/publishing",draft:!1,editUrl:"https://github.com/raystack/raccoon/edit/master/docs/docs/guides/publishing.md",tags:[],version:"current",frontMatter:{},sidebar:"docsSidebar",previous:{title:"Overview",permalink:"/raccoon/guides/overview"},next:{title:"Deployment",permalink:"/raccoon/guides/deployment"}},l={},p=[{value:"EndPoints",id:"endpoints",level:2},{value:"Authorization/Authentication",id:"authorizationauthentication",level:3},{value:"HTTP backend",id:"http-backend",level:3},{value:"gRPC backend",id:"grpc-backend",level:3},{value:"Data Formatters",id:"data-formatters",level:2},{value:"Protobuf",id:"protobuf",level:3},{value:"JSON",id:"json",level:3},{value:"Headers",id:"headers",level:2},{value:"gRPC",id:"grpc",level:2},{value:"Topics",id:"topics",level:2}],c={toc:p},g="wrapper";function u(e){let{components:t,...o}=e;return(0,r.yg)(g,(0,a.A)({},c,o,{components:t,mdxType:"MDXLayout"}),(0,r.yg)("h1",{id:"publishing-events"},"Publishing Events"),(0,r.yg)("h2",{id:"endpoints"},"EndPoints"),(0,r.yg)("p",null,"Raccoon can be hosted behind a proxy/API GW, a sample of blocks as below."),(0,r.yg)("p",null,(0,r.yg)("img",{src:n(5516).A,width:"513",height:"161"})),(0,r.yg)("p",null,"The HTTP API path which accepts events is:"),(0,r.yg)("p",null,(0,r.yg)("strong",{parentName:"p"},"/api/v1/events")),(0,r.yg)("p",null,"This path can be used for sending events by either connecting via websocket connection or as a normal REST API Request."),(0,r.yg)("p",null,"HTTP methods used for Endpoints are:"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("strong",{parentName:"li"},"Websocket")," - GET"),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("strong",{parentName:"li"},"REST")," - POST")),(0,r.yg)("h3",{id:"authorizationauthentication"},"Authorization/Authentication"),(0,r.yg)("p",null,"Raccoon does not provide features to perform any authorization or authentication of the user/client initiating the connection. It accepts connections as trusted ","(","and assumes any such auth is already performed",")"),(0,r.yg)("h3",{id:"http-backend"},"HTTP backend"),(0,r.yg)("p",null,"SSL termination is outside the scope of Raccoon, and the service API accepts HTTP connections assuming that the SSL is terminated at a proxy or ELB before reaching Raccoon."),(0,r.yg)("h3",{id:"grpc-backend"},"gRPC backend"),(0,r.yg)("p",null,"Similar to HTTP SSL termination is outside the scope of Raccoon, and the service API accepts connections assuming SSL is terminated at a proxy or ELB before reaching Raccoon."),(0,r.yg)("h2",{id:"data-formatters"},"Data Formatters"),(0,r.yg)("p",null,"Raccoon supports Protobuf and JSON as the primary data formatters. Protobuf can be used to send event via websocket, REST or gRPC whereas JSON is supported only for websocket and REST endpoint."),(0,r.yg)("p",null,"With a websocket connection the content type is identified based on the message type. If the message type is binary it is assumed that the formatting is protobuf and if the message type is text then formatting is assumed to be JSON."),(0,r.yg)("h3",{id:"protobuf"},"Protobuf"),(0,r.yg)("p",null,"Raccoon accepts a SendEventRequest proto that wraps multiple Event proto. This enables clients to send an event in real-time or multiple events in batches."),(0,r.yg)("p",null,"Refer to ",(0,r.yg)("a",{parentName:"p",href:"https://github.com/raystack/proton/blob/main/raystack/raccoon/v1beta1/raccoon.proto"},"raccoon.proto")," to learn how you can build the request."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-protobuf"},"message SendEventRequest {\n  string req_guid = 1;\n  google.protobuf.Timestamp sent_time = 2;\n  repeated Event events = 3;\n}\n")),(0,r.yg)("p",null,"Where :"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("strong",{parentName:"li"},"req_guid")," - A globally unique ID generated by the client denoting this request as unique "),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("strong",{parentName:"li"},"sent_time")," - This is when the event is sent over the WebSocket in protobuf timestamp format. This time is used to calculate latencies in Raccoon. "),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("strong",{parentName:"li"},"events")," - events of type Event proto. Refer to the ",(0,r.yg)("a",{parentName:"li",href:"https://github.com/raystack/proton/blob/main/raystack/raccoon/v1beta1/raccoon.proto"},"raccoon.proto")," to learn more.")),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-protobuf"},"message Event {\n\n  // Data/byteArray of the serialised product proto.\n  bytes eventBytes = 1;\n\n  /* This is the protoMessageName which the protoc provides \n   * with each compiled proto. This type is used by raccoon \n   * to distribute events to respective topics.\n   */\n  string type = 2;\n}\n")),(0,r.yg)("p",null,"Where:"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("strong",{parentName:"li"},"eventBytes")," - is a byte array serialized by the event proto ","(","eg. ViewedEvent.proto",")"," serializer client "),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("strong",{parentName:"li"},"type")," - event type which Raccoon uses to distribute the events to topics. More details in the following sections.")),(0,r.yg)("p",null,"Clients build the event array and compose the SendEventRequest proto, then send them through the WebSocket client."),(0,r.yg)("p",null,"Raccoon also wires a response every time a message is read and processed."),(0,r.yg)("p",null,"Refer to the ",(0,r.yg)("a",{parentName:"p",href:"https://github.com/raystack/proton/blob/main/raystack/raccoon/v1beta1/raccoon.proto"},"raccoon.proto")," that Raccoon sends for every event."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-protobuf"},"message SendEventResponse {\n  Status status = 1;\n  Code code = 2;\n  int64 sent_time = 3;                /* time when the response is generated */\n  string reason = 4;                  /* failure reasons if any */\n  map<string, string> data = 5;       /* Usually detailing the success/failures */\n}\n\nenum Status {\n    UNKNOWN_STATUS = 0;\n    SUCCESS = 1;                      /* signifies request success */\n    ERROR = 2;                        /* server request failures */\n}\n\nenum Code {\n    UNKNOWN_CODE = 0;\n    OK = 1;                           /* successfully read and deserialized */\n    BAD_REQUEST = 2;                  /* usually deserialization failures */\n    INTERNAL_ERROR = 3;               /* server runtime errors */\n    MAX_CONNECTION_LIMIT_REACHED = 4; /* max connection reached at the server */\n    MAX_USER_LIMIT_REACHED = 5;       /* user reached max connections allowed. Defaults to 1 */\n}\n")),(0,r.yg)("p",null,"The above response model is self-explanatory. Clients can choose to retry for error codes such as Code=","[","3","|","4","]"),(0,r.yg)("h3",{id:"json"},"JSON"),(0,r.yg)("p",null,"Sample JSON SendEventRequest"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-json"},'{\n  "req_guid": "1234abcd",\n  "sent_time": {\n    "seconds": 1638154927,\n    "nanos": 376499000\n  },\n  "events": [\n    {\n      "eventBytes": "Cg4KCHNlcnZpY2UxEgJBMRACIAEyiQEKJDczZTU3ZDlhLTAzMjQtNDI3Yy1hYTc5LWE4MzJjMWZkY2U5ZiISCcix9QzhsChAEekGEi1cMlNAKgwKAmlkEgJpZBjazUsyFwoDaU9zEgQxMi4zGgVBcHBsZSIDaTEwOiYKJDczZTU3ZDlhLTAzMjQtNDI3Yy1hYTc5LWE4MzJjMWZkY2U5Zg==",\n      "type": "booking"\n    }\n  ]\n}\n')),(0,r.yg)("table",null,(0,r.yg)("thead",{parentName:"table"},(0,r.yg)("tr",{parentName:"thead"},(0,r.yg)("th",{parentName:"tr",align:null},"Parameter"),(0,r.yg)("th",{parentName:"tr",align:null},"Data Type"),(0,r.yg)("th",{parentName:"tr",align:null},"Description"))),(0,r.yg)("tbody",{parentName:"table"},(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"req_guid"),(0,r.yg)("td",{parentName:"tr",align:null},"string"),(0,r.yg)("td",{parentName:"tr",align:null},"A globally unique Identifier generated by the client.")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"sent_time"),(0,r.yg)("td",{parentName:"tr",align:null},"Object"),(0,r.yg)("td",{parentName:"tr",align:null},"Unix time in seconds+nanoseconds when the event is sent to Raccoon")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"events"),(0,r.yg)("td",{parentName:"tr",align:null},"Array(Object)"),(0,r.yg)("td",{parentName:"tr",align:null},"Array of event objects")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"events.eventBytes"),(0,r.yg)("td",{parentName:"tr",align:null},"string"),(0,r.yg)("td",{parentName:"tr",align:null},"base64 string of bytes generated by json serializion of EventProto")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"events.type"),(0,r.yg)("td",{parentName:"tr",align:null},"string"),(0,r.yg)("td",{parentName:"tr",align:null},"Event type which Raccoon uses to distribute the events to topics")))),(0,r.yg)("p",null,"Sample JSON SendEventResponse"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-json"},'{\n  "status": 1,\n  "code": 1,\n  "sent_time": 1638155915,\n  "data": {\n    "req_guid": "1234abcd"\n  }\n}\n')),(0,r.yg)("table",null,(0,r.yg)("thead",{parentName:"table"},(0,r.yg)("tr",{parentName:"thead"},(0,r.yg)("th",{parentName:"tr",align:null},"Parameter"),(0,r.yg)("th",{parentName:"tr",align:null},"Data Type"),(0,r.yg)("th",{parentName:"tr",align:null},"Description"))),(0,r.yg)("tbody",{parentName:"table"},(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"status"),(0,r.yg)("td",{parentName:"tr",align:null},"int"),(0,r.yg)("td",{parentName:"tr",align:null},"status of the send event request")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"code"),(0,r.yg)("td",{parentName:"tr",align:null},"int"),(0,r.yg)("td",{parentName:"tr",align:null},"response code")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"sent_time"),(0,r.yg)("td",{parentName:"tr",align:null},"int"),(0,r.yg)("td",{parentName:"tr",align:null},"sent time in seconds")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"data"),(0,r.yg)("td",{parentName:"tr",align:null},"int"),(0,r.yg)("td",{parentName:"tr",align:null},"data map sent by the server, currently contains just the req_guid")),(0,r.yg)("tr",{parentName:"tbody"},(0,r.yg)("td",{parentName:"tr",align:null},"reason"),(0,r.yg)("td",{parentName:"tr",align:null},"string"),(0,r.yg)("td",{parentName:"tr",align:null},"reason for any failure if any")))),(0,r.yg)("p",null,"Values of status and codes is same as defined in Proto."),(0,r.yg)("h2",{id:"headers"},"Headers"),(0,r.yg)("p",null,"Raccoon service accepts headers to identify a user connection uniquely. The header name is made configurable as it enables clients to specify a header name that works for them. For, e.g. for a mobile app having a request header as ",(0,r.yg)("inlineCode",{parentName:"p"},"X-User-ID")," which identifies the user ","(","client",")"," connecting to Raccoon, can configure Raccoon service with the config set as below ",(0,r.yg)("inlineCode",{parentName:"p"},"SERVER_WEBSOCKET_CONN_ID_HEADER=X-User-ID"),". Optionally, ",(0,r.yg)("inlineCode",{parentName:"p"},"SERVER_WEBSOCKET_CONN_GROUP_HEADER")," can also be configured to ",(0,r.yg)("a",{parentName:"p",href:"/raccoon/concepts/architecture#connections"},"support multi-tenancy")," such as multiple apps connecting to a single Raccoon instance."),(0,r.yg)("p",null,"Raccoon uses the config to fetch the header name and uses the value passed in the request header with this name, as the connection id. This header name uniquely identifies a client. A client, in this case, can be the user in the app."),(0,r.yg)("p",null,"The following header is a sample providing a user id: 654785432. Once the client initiates a WebSocket upgrade request over Raccoon, assuming the request is upgraded, and the client connection is established, Racoon accepts the header and extracts the user id to build a connection map. This map helps deduplicate connections for a user within the same raccoon instance."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-json"},'{\n    "X-User-ID": "654785432"\n}\n')),(0,r.yg)("p",null,(0,r.yg)("inlineCode",{parentName:"p"},"Content-Type")," header is mandatory for sending event using REST API."),(0,r.yg)("p",null,"Following are the supported ",(0,r.yg)("inlineCode",{parentName:"p"},"Content-Type")," headers for various data formats:"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"Protobuf - ",(0,r.yg)("inlineCode",{parentName:"li"},"application/proto")),(0,r.yg)("li",{parentName:"ul"},"JSON - ",(0,r.yg)("inlineCode",{parentName:"li"},"application/json"))),(0,r.yg)("h2",{id:"grpc"},"gRPC"),(0,r.yg)("p",null,"Events can be sent to Raccoon using gRPC too."),(0,r.yg)("p",null,"Refer to ",(0,r.yg)("a",{parentName:"p",href:"https://github.com/raystack/proton/blob/main/raystack/raccoon/v1beta1/raccoon.proto"},"EventService")," for the definition of ",(0,r.yg)("inlineCode",{parentName:"p"},"EventService")," which exposes one RPC call ",(0,r.yg)("inlineCode",{parentName:"p"},"SendEvent"),". It is recommended to generate the language specific gRPC client using the proto definition."),(0,r.yg)("p",null,"Input to the RPC call is ",(0,r.yg)("a",{parentName:"p",href:"https://github.com/raystack/proton/blob/main/raystack/raccoon/v1beta1/raccoon.proto"},"SendEventRequest")," and the output is ",(0,r.yg)("a",{parentName:"p",href:"https://github.com/raystack/proton/blob/main/raystack/raccoon/v1beta1/raccoon.proto"},"SendEventResponse"),"."),(0,r.yg)("p",null,"To support multi-tenancy while using gRPC, ",(0,r.yg)("inlineCode",{parentName:"p"},"SERVER_WEBSOCKET_CONN_ID_HEADER")," and ",(0,r.yg)("inlineCode",{parentName:"p"},"SERVER_WEBSOCKET_CONN_GROUP_HEADER")," values can be used. The key along with their values should be set in the grpc metadata while sending the request. Golang client example -"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-go"},'md := metadata.New(map[string]string{"X-User-ID": "1234"})\nctx := metadata.NewOutgoingContext(context.Background(), md)\nr, err := client.SendEvent(ctx, req)\n')),(0,r.yg)("h2",{id:"topics"},"Topics"),(0,r.yg)("p",null,"Raccoon distributes events to a topic based on the event type. The protobuf section above clarifies how the type should be set in the event. The type is a string literal. For example, ViewedEvent - which signifies that the user viewed something on the app or the site can have its event type set as below ",(0,r.yg)("inlineCode",{parentName:"p"},"type = viewedevent")),(0,r.yg)("p",null,"When raccoon API consumes a batch array of events ","(","events in SendEventRequest proto",")",", it deserializes them and fetches the individual events ","(","using the SendEventRequest proto",")",", and constructs the topic to send each event to based on the ",(0,r.yg)("inlineCode",{parentName:"p"},"type")," field set in each of the events."),(0,r.yg)("p",null,"The following code determines the topic name."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-go"},'topic := strings.Replace(p.topicFormat, "%s", event.Type, 1)\n')),(0,r.yg)("p",null,"where ",(0,r.yg)("strong",{parentName:"p"},"topicformat")," - is the configured pattern ",(0,r.yg)("inlineCode",{parentName:"p"},"EVENT_DISTRIBUTION_PUBLISHER_PATTERN")," ",(0,r.yg)("strong",{parentName:"p"},"type")," - is the type set by the client when the event proto is generated"),(0,r.yg)("p",null,"For e.g. setting the"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-bash"},"EVENT_DISTRIBUTION_PUBLISHER_PATTERN=topic-%s-log\n")),(0,r.yg)("p",null,"and a type such as ",(0,r.yg)("inlineCode",{parentName:"p"},"type=viewedevent")," in the event"),(0,r.yg)("p",null,"will have the topic name as ",(0,r.yg)("inlineCode",{parentName:"p"},"topic-viewedevent-log")))}u.isMDXComponent=!0},5516:(e,t,n)=>{n.d(t,{A:()=>a});const a=n.p+"assets/images/raccoon_ep-2f003a95743c872cbd23fe5f2cf5fb1e.png"}}]);